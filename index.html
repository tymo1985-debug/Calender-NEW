<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Service Pro v59.5 Stable</title>

  <!-- PWA -->
  <meta name="theme-color" content="#2e7d32">
  <link rel="manifest" href="/Calender-NEW/manifest.json?v=60.1">
  
  <style>
    :root { --primary: #2e7d32; --bg: #f0f2f5; }
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    header { background: var(--primary); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 10; height: 50px; flex-shrink: 0; }
    main { display: flex; flex: 1; overflow: hidden; position: relative; width: 100%; }
    #left-panel { min-width: 400px; overflow-y: auto; padding: 20px; box-sizing: border-box; flex: 1; }
    #resizer { width: 6px; cursor: col-resize; background: #ccc; transition: 0.2s; z-index: 5; flex-shrink: 0; }
    #resizer:hover { background: var(--primary); }
    #right-panel { min-width: 350px; overflow-y: auto; padding: 20px; box-sizing: border-box; background: #fff; border-left: 1px solid #ccc; width: 520px; flex-shrink: 0; }

    table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    th { background: #e8f5e9; color: var(--primary); padding: 12px; font-size: 11px; position: sticky; top: 0; text-transform: uppercase; border-bottom: 2px solid #c8e6c9; text-align: left; }
    td { border-bottom: 1px solid #eee; padding: 8px; font-size: 13px; vertical-align: middle; }
    .sched-text { font-size: 11px; color: #444; white-space: nowrap; }
    input, select, textarea { width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 6px; box-sizing: border-box; font-size: 12px; }
    textarea { height: 32px; resize: none; border: none; background: transparent; width: 100%; }

    .card { background: #fff; border: 1px solid #e0e0e0; border-radius: 12px; padding: 15px; margin-bottom: 20px; }
    .btn { border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }

    .color-picker { display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; margin: 10px 0; }
    .color-dot { height: 22px; border-radius: 4px; cursor: pointer; border: 2px solid transparent; }
    .color-dot.active { border-color: #000; box-shadow: 0 0 5px rgba(0,0,0,0.2); }

    .mini-grid { display: grid; grid-template-columns: 30px repeat(7, 1fr); gap: 2px; font-size: 10px; text-align: center; }
    .week-cell { background: #f1f8e9; color: var(--primary); font-weight: bold; border-radius: 3px; display: flex; align-items: center; justify-content: center; transition: 0.15s; user-select: none; }
    .week-cell:hover { background: #c8e6c9; cursor: pointer; }
    .day-cell { background: #f9f9f9; padding: 4px 0; border-radius: 3px; border: 1px solid transparent; transition: 0.2s; }

    .m-item { padding: 10px; border-radius: 6px; background: #f8f9fa; margin-bottom: 6px; border-left: 5px solid; display: flex; justify-content: space-between; align-items: center; font-size: 12px; }
    .actions span { cursor: pointer; margin-left: 10px; }

    /* –°—Ç—Ä–æ–∫–∞ –Ω–µ–¥–µ–ª–∏ (–±–µ–∑ –ø–æ–ª–æ–º–∫–∏ —Å–µ—Ç–∫–∏) */
    .week-row { display: contents; }
    .week-row:hover .week-cell, .week-row:hover .day-cell { outline: 1px dashed #a5d6a7; background: #e8f5e9; }

    /* –í—Å–ø—ã—à–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ –Ω–µ–¥–µ–ª–µ */
    @keyframes wkflash { 0%{ box-shadow:0 0 0 0 rgba(46,125,50,.0);} 30%{ box-shadow:0 0 0 6px rgba(46,125,50,.25);} 100%{ box-shadow:0 0 0 0 rgba(46,125,50,.0);} }
    .flash .week-cell, .flash .day-cell { animation: wkflash .75s ease-out 0s 1; }

    /* –õ–∏–Ω–∫–æ–ø–æ–¥–æ–±–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–æ–º–µ—Ä–∞ –Ω–µ–¥–µ–ª–∏ –≤ –ª–µ–≤–æ–π —Ç–∞–±–ª–∏—Ü–µ */
    .linklike { background: transparent; border: none; color: var(--primary); font-weight: 700; cursor: pointer; padding: 0; }
    .linklike:hover { text-decoration: underline; }

    /* –í—Å–ø—ã—à–∫–∞ —Å—Ç—Ä–æ–∫–∏ —Å–ª–µ–≤–∞ */
    @keyframes rowflash { 0% { background: #e8f5e9; } 100% { background: transparent; } }
    .row-flash { animation: rowflash .9s ease-out 0s 1; }

    /* –õ–µ–≥–µ–Ω–¥–∞ */
    .legend { display:flex; flex-wrap: wrap; gap:8px; margin-top:8px; }
    .legend-item { display:flex; align-items:center; gap:6px; padding:4px 6px; border:1px solid #e0e0e0; border-radius:6px; cursor:pointer; user-select:none; font-size:12px; }
    .legend-swatch { width:14px; height:14px; border-radius:3px; border:1px solid rgba(0,0,0,.15); }
    .legend-item.active { outline: 2px solid var(--primary); }

    /* –ü–µ—á–∞—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–µ—á–∞—Ç–∞–µ—Ç—Å—è –ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å) */
    @media print {
      body:not(.print-cal) #right-panel, body:not(.print-cal) #resizer, body:not(.print-cal) header { display: none !important; }
      body:not(.print-cal) #left-panel { width: 100%; padding: 0; }
    }
    /* –†–µ–∂–∏–º –ø–µ—á–∞—Ç–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è (–¥–ª—è PDF) */
    @media print {
      body.print-cal #left-panel, body.print-cal #resizer, body.print-cal header { display:none !important; }
      body.print-cal #right-panel { display:block !important; width:100% !important; border:none; }
    }

    /* PWA Update Banner */
    #pwa-update-banner { position: fixed; left: 16px; right: 16px; bottom: 16px; z-index: 9999; background: #ffffff; border: 1px solid #e0e0e0; box-shadow: 0 10px 30px rgba(0,0,0,.15); border-radius: 12px; padding: 12px 14px; display: flex; gap: 12px; align-items: center; }
    #pwa-update-banner[hidden] { display: none !important; }
    #pwa-update-banner .pwa-upd-icon { width: 28px; height: 28px; border-radius: 6px; background: #e8f5e9; color: #2e7d32; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
    #pwa-update-banner .pwa-upd-text { font-size: 14px; line-height: 1.25; color: #263238; flex: 1; }
    #pwa-update-banner .pwa-upd-actions { display: flex; gap: 8px; align-items: center; flex-wrap: nowrap; }
    #pwa-update-banner .btn-upd-apply { background: #2e7d32; color:#fff; border: none; border-radius: 8px; padding: 8px 12px; font-weight: 700; cursor: pointer; }
    #pwa-update-banner .btn-upd-later { background: transparent; color:#2e7d32; border: 1px solid #c8e6c9; border-radius: 8px; padding: 8px 12px; font-weight: 700; cursor: pointer; }
    #pwa-update-banner .btn-upd-close { background: transparent; border: none; color: #607d8b; cursor: pointer; font-size: 18px; line-height: 1; padding: 4px; margin-left: 4px; }

    @media (max-width: 480px) {
      #pwa-update-banner { left: 8px; right: 8px; bottom: 8px; padding: 10px; }
      #pwa-update-banner .pwa-upd-text { font-size: 13px; }
    }
  </style>
</head>
<body>

<header>
  <div style="font-weight: bold;">SERVICE PRO v59.5</div>
  <div style="display: flex; gap: 8px; flex-wrap:wrap;">
    <button class="btn" style="background:#546e7a;" onclick="exportJSON()">üì§ –ë—ç–∫–∞–ø</button>
    <button class="btn" style="background:#78909c;" onclick="importJSON()">üì• –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>

    <button class="btn" style="background:#00695c;" onclick="exportICS()">üìÖ –≠–∫—Å–ø–æ—Ä—Ç ICS</button>
    <label class="btn" style="background:#00796b; display:flex; align-items:center; gap:6px;">
      <input id="icsFile" type="file" accept=".ics,text/calendar" style="display:none" onchange="importICSFile(this)">
      <span onclick="document.getElementById('icsFile').click()">üì• –ò–º–ø–æ—Ä—Ç ICS</span>
    </label>

    <button class="btn" style="background:#8e24aa;" onclick="printCalendar()">üñ® –ü–µ—á–∞—Ç—å PDF</button>
    <button class="btn" style="background:#b71c1c;" onclick="resetPWA()">üßπ –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à</button>

    <select id="yearSelect" onchange="renderAll()" style="width: 80px; font-weight:bold; border-radius: 4px;">
      <option value="2025">2025</option>
      <option value="2026" selected>2026</option>
      <option value="2027">2027</option>
    </select>
  </div>
</header>

<main>
  <div id="left-panel">
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
      <label style="display:flex; align-items:center; gap:6px; font-size:13px; color:#455a64;">
        <input type="checkbox" id="autoToday" onchange="toggleAutoToday(this.checked)">
        –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
      </label>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width: 30px;">‚Ññ</th>
          <th style="width: 110px;">–ù–∞—á–∞–ª–æ</th>
          <th style="width: 110px;">–ö–æ–Ω–µ—Ü</th>
          <th>–°–æ–±—Ä–∞–Ω–∏–µ / –°–æ–±—ã—Ç–∏–µ</th>
          <th style="width: 110px;">–ë—É–¥–Ω–∏</th>
          <th style="width: 110px;">–í—ã—Ö–æ–¥–Ω–æ–π</th>
          <th>–ó–∞–º–µ—Ç–∫–∏</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div id="resizer"></div>

  <div id="right-panel">
    <div class="card">
      <h4 id="tplTitle" style="margin:0 0 10px 0;">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –°–æ–±—Ä–∞–Ω–∏—è</h4>
      <input id="mName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –°–æ–±—Ä–∞–Ω–∏—è/–°–æ–±—ã—Ç–∏—è">

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px;">
        <div>
          <small>–ë—É–¥–Ω–∏–π –¥–µ–Ω—å:</small>
          <select id="mDefWD"><option value="">-</option><option>–ü–Ω</option><option>–í—Ç</option><option>–°—Ä</option><option>–ß—Ç</option><option>–ü—Ç</option></select>
          <input type="time" id="mTimeWD" style="margin-top:4px;">
        </div>
        <div>
          <small>–í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å:</small>
          <select id="mDefWE"><option value="">-</option><option>–°–±</option><option>–í—Å</option></select>
          <input type="time" id="mTimeWE" style="margin-top:4px;">
        </div>
      </div>

      <div class="color-picker" id="pnlColors"></div>
      <input type="hidden" id="selectedColor" value="#2e7d32">
      <input type="hidden" id="editIdx" value="-1">

      <div style="display: flex; gap: 5px; margin-top: 10px;">
        <button id="btnSave" class="btn" style="background:var(--primary); flex: 2;" onclick="addMeeting()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="btnCancel" class="btn" style="background:#999; flex: 1; display: none;" onclick="cancelEdit()">–û—Ç–º–µ–Ω–∞</button>
      </div>

      <div id="meetingsList" style="margin-top: 15px; max-height: 150px; overflow-y: auto;"></div>
    </div>

    <div class="card">
      <h4 style="margin:0 0 10px 0;">–ö–∞–ª–µ–Ω–¥–∞—Ä—å (1-52)</h4>
      <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px;">
        <select id="filterMeeting" onchange="buildCal()" style="flex:1; min-width:220px;">
          <option value="">‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å–æ–±—ã—Ç–∏—è ‚Äî</option>
        </select>
        <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#455a64; white-space:nowrap;">
          <input type="checkbox" id="filterStrict" onchange="buildCal()"> –°–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–æ—á–∏–µ
        </label>
        <button class="btn" style="background:#607d8b;" onclick="clearFilter()">–°–±—Ä–æ—Å</button>
        <button class="btn" style="background:#388e3c;" onclick="goToToday()">–°–µ–≥–æ–¥–Ω—è</button>
        <button class="btn" style="background:#5c6bc0;" onclick="gotoPrevMarked()">‚óÄ –ü—Ä–µ–¥.</button>
        <button class="btn" style="background:#5c6bc0;" onclick="gotoNextMarked()">–°–ª–µ–¥. ‚ñ∂</button>
      </div>

      <div id="calendarArea"></div>
      <div id="legendArea" class="legend"></div>
    </div>
  </div>
</main>

<!-- PWA Update Banner -->
<div id="pwa-update-banner" role="status" aria-live="polite" hidden>
  <div class="pwa-upd-icon" aria-hidden="true">üîÑ</div>
  <div class="pwa-upd-text">–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å?</div>
  <div class="pwa-upd-actions">
    <button class="btn-upd-apply" id="pwaApplyBtn">–û–±–Ω–æ–≤–∏—Ç—å</button>
    <button class="btn-upd-later" id="pwaLaterBtn">–ü–æ–∑–∂–µ</button>
    <button class="btn-upd-close" id="pwaCloseBtn" title="–°–∫—Ä—ã—Ç—å">‚úï</button>
  </div>
</div>

<script>
let meetings = JSON.parse(localStorage.getItem('svc_m')) || [];
const CLRS = ['#2e7d32','#d32f2f','#1976d2','#ef6c00','#7b1fa2','#0097a7','#5d4037','#455a64'];

const resizer = document.getElementById('resizer');
const rightPanel = document.getElementById('right-panel');
let isResizing = false;
let currentFocusWeek = 1;

resizer.addEventListener('mousedown', () => { isResizing = true; document.body.style.userSelect = 'none'; });
document.addEventListener('mousemove', (e) => { if (!isResizing) return; let w = window.innerWidth - e.clientX; if (w > 300 && w < 950) rightPanel.style.width = w + 'px'; });
document.addEventListener('mouseup', () => { isResizing = false; document.body.style.userSelect = 'auto'; });

window.onload = () => {
  // –ü–∞–ª–∏—Ç—Ä–∞
  const pnl = document.getElementById('pnlColors');
  CLRS.forEach((c, idx) => {
    const dot = document.createElement('div');
    dot.className = 'color-dot' + (idx===0?' active':'');
    dot.style.background = c;
    dot.setAttribute('data-color', c);
    dot.onclick = () => {
      document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
      dot.classList.add('active');
      document.getElementById('selectedColor').value = c;
    };
    pnl.appendChild(dot);
  });

  // –ê–≤—Ç–æ-–ø–µ—Ä–µ—Ö–æ–¥ –∫ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–µ
  document.getElementById('autoToday').checked = localStorage.getItem('svc_auto_today') !== '0';

  generateYearOptions();
  renderAll();

  if (localStorage.getItem('svc_auto_today') !== '0') {
    setTimeout(()=>{ goToToday(); }, 300);
  }

  handleHashAction();
  window.addEventListener('hashchange', handleHashAction);
};

function toggleAutoToday(v){ localStorage.setItem('svc_auto_today', v ? '1':'0'); }

// ===== –ê–≤—Ç–æ-–≥–æ–¥—ã =====
function generateYearOptions() {
  const yearSelect = document.getElementById('yearSelect');
  if(!yearSelect) return;

  yearSelect.innerHTML = '';
  const currentYear = new Date().getFullYear();
  for (let y = currentYear - 2; y <= currentYear + 5; y++) {
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    yearSelect.appendChild(opt);
  }
  yearSelect.value = currentYear;
}

function handleHashAction() {
  const h = location.hash.replace('#', '').toLowerCase();
  if (h === 'today') goToToday();
  else if (h === 'next') gotoNextMarked();
  else if (h === 'prev') gotoPrevMarked();
  else if (h === 'add') {
    const inp = document.getElementById('mName');
    if (inp) { inp.focus(); inp.scrollIntoView({behavior:'smooth', block:'center'}); }
  }
}

// ===== Render =====
function renderAll() {
  const year = document.getElementById('yearSelect').value;
  const tbody = document.getElementById('tableBody');
  const data = JSON.parse(localStorage.getItem('svc_d_' + year)) || [];
  tbody.innerHTML = '';

  const fragment = document.createDocumentFragment();

  for (let i = 1; i <= 52; i++) {
    const row = data.find(r => r.id == i) || {};
    const m = meetings.find(x => x.name === row.m) || {};
    const wdStr = (m.wd || m.tWD) ? `${m.wd || ''} ${m.tWD || ''}`.trim() : '';
    const weStr = (m.we || m.tWE) ? `${m.we || ''} ${m.tWE || ''}`.trim() : '';

    const tr = document.createElement('tr');
    tr.id = `row-wk-${i}`;
    tr.innerHTML = `
      <td style="text-align:center; color:#4caf50;">
        <button class="linklike" title="–ü–µ—Ä–µ–π—Ç–∏ –∫ –Ω–µ–¥–µ–ª–µ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ" onclick="goToWeek(${i})">${i}</button>
      </td>
      <td><input type="date" value="${row.s || ''}" onchange="autoEnd(this)"></td>
      <td><input type="date" class="d-e" value="${row.e || ''}" onchange="saveData()"></td>
      <td>
        <select onchange="saveData()" class="m-select">
          <option value="">- –Ω–µ—Ç —Å–æ–±—ã—Ç–∏—è -</option>
          ${meetings.map(x => `<option value="${x.name}" ${x.name === row.m ? 'selected' : ''}>${x.name}</option>`).join('')}
        </select>
      </td>
      <td class="sched-text">${wdStr}</td>
      <td class="sched-text">${weStr}</td>
      <td><textarea oninput="saveData()">${row.nt || ''}</textarea></td>
    `;
    fragment.appendChild(tr);
  }
  tbody.appendChild(fragment);
  updateMList();
  buildCal();
}

function autoEnd(el) {
  let s = new Date(el.value);
  if(!isNaN(s.getTime())) {
    let e = new Date(s);
    const day = s.getDay();
    // –µ—Å–ª–∏ –≤—Ç–æ—Ä–Ω–∏–∫, –¥–æ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è
    if(day === 2) e.setDate(s.getDate() + 5);
    else e.setDate(s.getDate() + 6);
    el.closest('tr').querySelector('.d-e').value = e.toISOString().split('T')[0];
  }
  saveData();
}

// ===== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á =====
function addMeeting() {
  const name = document.getElementById('mName').value;
  const editIdx = parseInt(document.getElementById('editIdx').value);
  if (!name) return;
  const obj = {
    name,
    color: document.getElementById('selectedColor').value,
    wd: document.getElementById('mDefWD').value,
    we: document.getElementById('mDefWE').value,
    tWD: document.getElementById('mTimeWD').value,
    tWE: document.getElementById('mTimeWE').value
  };
  if (editIdx > -1) { meetings[editIdx] = obj; } else { meetings.push(obj); }
  localStorage.setItem('svc_m', JSON.stringify(meetings));
  cancelEdit();
  renderAll();
}

function editM(i) {
  const m = meetings[i];
  document.getElementById('mName').value = m.name;
  document.getElementById('mDefWD').value = m.wd || "";
  document.getElementById('mDefWE').value = m.we || "";
  document.getElementById('mTimeWD').value = m.tWD || "";
  document.getElementById('mTimeWE').value = m.tWE || "";
  document.getElementById('selectedColor').value = m.color;

  document.querySelectorAll('.color-dot').forEach(d => {
    d.classList.toggle('active', d.getAttribute('data-color') === m.color);
  });

  document.getElementById('editIdx').value = i;
  document.getElementById('btnSave').innerText = "–û–±–Ω–æ–≤–∏—Ç—å";
  document.getElementById('btnCancel').style.display = "inline-block";
}

function cancelEdit() {
  document.getElementById('mName').value = '';
  document.getElementById('mTimeWD').value = ''; document.getElementById('mTimeWE').value = '';
  document.getElementById('mDefWD').value = ''; document.getElementById('mDefWE').value = '';
  document.getElementById('editIdx').value = "-1";
  document.getElementById('btnSave').innerText = "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
  document.getElementById('btnCancel').style.display = "none";
}

function updateMList() {
  const l = document.getElementById('meetingsList');
  l.innerHTML = meetings.map((m, i) => `
    <div class="m-item" style="border-left-color:${m.color}">
      <span><b>${m.name}</b></span>
      <div class="actions">
        <span onclick="editM(${i})">‚úé</span>
        <span onclick="delM(${i})" style="color:red;">‚úï</span>
      </div>
    </div>
  `).join('');
}

function delM(i) { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { meetings.splice(i,1); localStorage.setItem('svc_m', JSON.stringify(meetings)); renderAll(); } }

function saveData() {
  const y = document.getElementById('yearSelect').value;
  const rows = Array.from(document.querySelectorAll('#tableBody tr')).map((tr, i) => ({
    id: i + 1,
    s: tr.querySelectorAll('input[type="date"]')[0].value,
    e: tr.querySelectorAll('input[type="date"]')[1].value,
    m: tr.querySelector('.m-select').value,
    nt: tr.querySelector('textarea').value
  }));
  localStorage.setItem('svc_d_' + y, JSON.stringify(rows));
  buildCal();
}

// ===== ICS =====
function exportICS(){
  const year = document.getElementById('yearSelect').value;
  const rows = JSON.parse(localStorage.getItem('svc_d_'+year)||'[]');
  let ics = ['BEGIN:VCALENDAR','VERSION:2.0','CALSCALE:GREGORIAN','PRODID:-//ServicePro//Calendar//RU'];

  rows.forEach(r=>{
    if(!r || !r.s || !r.m) return;

    const uid = Date.now() + '-' + Math.random().toString(36).slice(2);
    const now = new Date().toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z';
    ics.push('BEGIN:VEVENT');
    ics.push('UID:' + uid);
    ics.push('DTSTAMP:' + now);

    const dtStart = r.s.replace(/-/g,'');
    const endDate = new Date(r.e || r.s);
    endDate.setDate(endDate.getDate() + 1); // ICS exclusive
    const dtEnd = endDate.toISOString().slice(0,10).replace(/-/g,'');

    ics.push('DTSTART;VALUE=DATE:' + dtStart);
    ics.push('DTEND;VALUE=DATE:' + dtEnd);

    ics.push('SUMMARY:' + (r.m || 'Service'));
    if(r.nt) ics.push('DESCRIPTION:' + r.nt.replace(/\n/g,'\\n'));
    ics.push('END:VEVENT');
  });
  ics.push('END:VCALENDAR');

  const blob = new Blob([ics.join('\n')], {type:'text/calendar'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='servicepro-'+year+'.ics'; a.click();
}
</script>

</body>
</html>
